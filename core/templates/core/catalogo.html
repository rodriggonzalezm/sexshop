{% extends 'core/base.html' %}

{% block title %}
Catálogo de Productos Eróticos | Triple Equis, Sexshop en Concepción
{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-12">
  <h1 class="text-4xl font-extrabold text-pink-600 mb-12 text-center tracking-widest">
    Catálogo de Productos Eróticos
  </h1>

  {% if messages %}
    <div class="mb-8 max-w-4xl mx-auto space-y-4">
      {% for message in messages %}
        <div class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-colors duration-300"
             role="alert" aria-live="polite">
          <strong class="mr-2">¡Éxito!</strong>{{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-10">
    {% for producto in productos %}
      <article
        class="bg-white rounded-2xl shadow-xl flex flex-col hover:shadow-2xl transition-shadow duration-300 group"
        x-data="{
          mainImage: '{{ producto.imagen.url if producto.imagen else '' }}',
          reset() { this.mainImage = '{{ producto.imagen.url if producto.imagen else '' }}' },
          setImage(url) { this.mainImage = url }
        }"
        @mouseleave="reset"
      >

        <a href="{% url 'producto_detalle' producto.codigo %}" class="block relative rounded-t-2xl overflow-hidden">
          <template x-if="mainImage">
            <img :src="mainImage" 
                 :alt="`Imagen principal de ${'{{ producto.nombre }}'}`"
                 loading="lazy"
                 class="w-full h-60 object-cover rounded-t-2xl transform transition-transform duration-300 group-hover:scale-105"
            />
          </template>

          <template x-if="!mainImage">
            <div class="bg-gray-200 h-60 flex items-center justify-center rounded-t-2xl text-gray-400 italic select-none">
              Imagen no disponible
            </div>
          </template>

          {% with producto.imagenes_adicionales.all|slice:":4" as miniaturas %}
            {% if miniaturas %}
              <div class="absolute bottom-3 left-3 flex gap-3 bg-white bg-opacity-80 backdrop-blur-md rounded-xl p-1 shadow-lg">
                {% for img in miniaturas %}
                  <img
                    src="{{ img.imagen.url }}"
                    alt="Miniatura {{ forloop.counter }} de {{ producto.nombre }}"
                    class="h-14 w-14 rounded-lg border-2 border-transparent cursor-pointer object-cover shadow-sm transition duration-300 hover:border-pink-500 focus:border-pink-500 focus:outline-none"
                    @mouseenter="setImage('{{ img.imagen.url }}')"
                    tabindex="0"
                    @focus="setImage('{{ img.imagen.url }}')"
                    @blur="reset()"
                  />
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        </a>

        <div class="p-6 flex flex-col flex-grow">
          <h2 class="text-xl font-bold text-pink-700 mb-1 truncate" title="{{ producto.nombre }}">
            <a href="{% url 'producto_detalle' producto.codigo %}" class="hover:underline focus:outline-none focus:ring-2 focus:ring-pink-400 rounded">
              {{ producto.nombre }}
            </a>
          </h2>

          <p class="text-gray-400 text-sm mb-3">Código: <span class="font-mono">{{ producto.codigo }}</span></p>

          <p class="text-pink-600 font-extrabold text-2xl mb-6">
            $ {{ producto.precio|floatformat:0 }}
          </p>

          <form method="post" action="{% url 'agregar_al_carrito' producto.codigo %}" class="mt-auto">
            {% csrf_token %}
            <button type="submit"
                    class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 rounded-xl shadow-md focus:outline-none focus:ring-4 focus:ring-pink-400 transition duration-300"
                    aria-label="Agregar {{ producto.nombre }} al carrito">
              🛒 Agregar al carrito
            </button>
          </form>
        </div>
      </article>
    {% empty %}
      <p class="text-center text-gray-600 col-span-full">No hay productos disponibles en este momento.</p>
    {% endfor %}
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}
